{% extends "navbar.html" %}
{% load static %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<body style="background-color: #d9f1ff; background-size: 100%;">
{% block content %}
    <h2 class="text-center my-4">Atmos Sense Live Data</h2>
    <div class="container-fluid">
        <div class="row">
            <!-- Main Content -->
            <div class="col-md-9">
                <div class="container mt-4">
                    <div class="row">
                        <!-- Temperature Card -->
                        <div class="col-md-3">
                            <div class="card text-center h-100" style="border-radius: 15px; background-color: #ffa07a;">
                                <div class="card-body">
                                    <h5 class="card-title">Soil and Atmospheric Tmp</h5>
                                    <div class="d-flex justify-content-center align-items-center mt-2">
                                        <i class="fas fa-thermometer-half small-icon me-2"></i>
                                        <p class="card-text" id="temperature">24°C - 94°C</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Humidity Card -->
                        <div class="col-md-3">
                            <div class="card text-center h-100" style="border-radius: 15px; background-color: #87ceeb;">
                                <div class="card-body">
                                    <h5 class="card-title">Soil Moisture</h5>
                                    <div class="d-flex justify-content-center align-items-center mt-2">
                                        <i class="fas fa-tint small-icon me-2"></i>
                                        <p class="card-text" id="moisture">60%</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Occupancy Card -->
                        <div class="col-md-3">
                            <div class="card text-center h-100" style="border-radius: 15px; background-color: #f4a460;">
                                <div class="card-body">
                                    <h5 class="card-title">Atmospheric Humidity</h5>
                                    <div class="d-flex justify-content-center align-items-center mt-2">
                                        <i class="fas fa-cloud small-icon me-2"></i>
                                        <p class="card-text" id="atmosHumidity">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Light Intensity Card -->
                        <div class="col-md-3">
                            <div class="card text-center h-100" style="border-radius: 15px; background-color: #fffacd;">
                                <div class="card-body">
                                    <h5 class="card-title">Light Intensity</h5>
                                    <div class="d-flex justify-content-center align-items-center mt-2">
                                        <i class="fas fa-sun small-icon me-2"></i>
                                        <p class="card-text" id="lightIntensity">300 lum</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- New row for Image and Map Cards -->
                    <div class="row mt-4">
                        <!-- Image Card -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <img class="card-img-top" src="https://www.pradan.net/sampark/wp-content/uploads/2023/03/Picture1-1.jpg" alt="Card image" id="deviseImage" style="height: 350px; object-fit: cover;">
                                <!-- <img class="card-img-top" src="{{ request.scheme }}://{{ request.get_host }}/media/img_PF4nb1i.jpg" alt="Card image" id="deviseImage" style="height: 300px; object-fit: cover;"> -->
                                <div class="card-body">
                                    <h5 class="card-title">Device Image</h5>
                                    <!-- <p class="card-text">Current image of the devise</p> -->
                                </div>
                            </div>
                        </div>
                        <!-- Map Card -->
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body" style="padding: 0;">
                                    <h5 class="card-title">Location Map</h5>
                                    <div id="map" style="height: 350px; width: 100%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Device List Sidebar -->
            <div class="col-md-3">
                <div id="deviseList" class="list-group mt-4" style="background-color: #e0f7fa;">
                    <h5 class="text-center">Devise APIs</h5>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

</body>

<!-- Leaflet.js for Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>

    const base_url   = `${window.location.protocol}//${window.location.host}`;
    const url        = `${base_url}/atmos-sense-devise-overview-data/`;
    let deviseData   = {}; // Declare 'data' outside so it can be accessed later
    const deviseList = document.getElementById('deviseList');

    async function fetchData() {
        try {
            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            // Parse the JSON data
            deviseData = await response.json();

            return deviseData.data;

        } catch (error) {
            console.error('Error:', error);
        }
    }

    function updateDeviseList(deviseData) {
        // Check if the deviseData is valid before proceeding
        if (!deviseData || deviseData.length === 0) {
            console.error('No data available to display');
            return;
        }

        // Reset the content of 'deviseList'
        deviseList.innerHTML = '<h5 class="text-center">Devices</h5>';
        
        // Iterate over the keys of 'deviseData'
        deviseData.forEach((devise, index) => {
            const apiName = `API ${index + 1}`; // Prefix each with 'API' and index
            const listItem = document.createElement('a');
            listItem.href = '#';
            listItem.className = 'list-group-item list-group-item-action';
            listItem.textContent = apiName;
            
            // Onclick function that passes the 'index' to the function
            listItem.onclick = () => loadDeviceData(index);

            // Append the created list item to the 'deviseList' container
            deviseList.appendChild(listItem);
        });

        // Load the first device's data by default
        loadDeviceData(0);
    }

    // Function to load device data based on index
    function loadDeviceData(index) {
        const data = deviseData.data[index];
        if (data) {
            document.getElementById('temperature').innerText = `${data.field1} °C - ${data.field3} °C`;
            document.getElementById('moisture').innerText = data.field3;
            document.getElementById('atmosHumidity').innerText = data.field4;
            document.getElementById('lightIntensity').innerText = data.field5;
            document.getElementById('deviseImage').src = `${base_url}/${data.image_path}`;
            updateMap([data.field6, data.field7]);
        }
    }

    // Call the fetchData and update every 5 seconds
    setInterval(() => {
        fetchData().then(deviseData => {
            if (deviseData) {
                updateDeviseList(deviseData);
            }
        });
    }, 5000);

    // Initial call to load data when the page loads
    fetchData().then(deviseData => {
        if (deviseData) {
            updateDeviseList(deviseData);
        }
    });

    // Initialize the map
    var map;
    function initMap() {
        map = L.map('map').setView([15.3647, 75.1240], 13); // Default coordinates
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);
    }

    // Update map location
    function updateMap(coordinates) {
        map.setView(coordinates, 13);
        if (window.currentMarker) {
            map.removeLayer(window.currentMarker);
        }
        window.currentMarker = L.marker(coordinates).addTo(map);
    }

    // Call initMap when the page loads
    window.onload = initMap;
</script>

<style>
    .card {
        border-radius: 10px;
    }
    .card .card-body {
        display: flex;
        flex-direction: column; /* Stack items vertically */
        align-items: center;
    }
    .card .card-body h5 {
        margin-bottom: 0;
    }
    .small-icon {
        font-size: 1.2rem; /* Adjust the size as needed */
    }
    .card-text {
        margin-left: 10px; /* Adjust this value to increase or decrease the space */
    }
</style>
